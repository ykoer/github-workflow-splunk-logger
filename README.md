# GitHub Action: Send Workflow Logs to Splunk
This action collects GitHub workflow logs and sends them to a Splunk HTTP Event Collector (HEC).

## Features

- Sends workflow run metadata to Splunk
- Optionally collects and sends individual job logs

## Usage

```yaml
name: CI with Splunk Logging

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Build and test
      run: |
        echo "Running build and tests..."
        # Your build commands here

    - name: Send logs to Splunk
      uses: ykoer/github-workflow-splunk-logger@v1
      with:
        splunk_url: ${{ secrets.SPLUNK_URL }}
        splunk_token: ${{ secrets.SPLUNK_HEC_TOKEN }}
```

## Inputs

| Input | Description | Required | Default |
|-------|-------------|----------|---------|
| `splunk_url` | URL of the Splunk HTTP Event Collector (HEC) including the port | Yes | N/A |
| `splunk_token` | Token for Splunk HEC API access | Yes | N/A |
| `github_token` | Token for Github API | Yes | N/A |
| `run_id` | ID of the specific workflow run | No | Current run ID |
| `index` | Splunk index to send the logs to | No | `github_workflows` |
| `source_type` | Splunk source type for the data | No | `github:workflow:logs` |
| `ssl_verify` | Whether to verify SSL certificates when connecting to Splunk | No | `true` |
| `include_job_steps` | Whether to include individual job step logs | No | `true` |
| `timeout` | HTTP request timeout in seconds | No | `30` |
| `max_retries` | Maximum number of retries for failed requests | No | `3` |

## Outputs

This action does not provide any outputs.

## Environment Variables

These environment variables are automatically set by GitHub Actions and are required to fetch workflow logs:

- `GITHUB_API_URL`: The base URL for GitHub’s API. It is used to interact with GitHub’s REST API, such as fetching logs, repository information, or workflow details.
- `GITHUB_REPOSITORY`: The name of the repository where the workflow is running, in the format owner/repo.
- `GITHUB_TOKEN`: A temporary authentication token automatically generated by GitHub Actions. It is used to authenticate API requests to GitHub 
- `GITHUB_REF`: A temporary authentication token automatically generated by GitHub Actions. It is used to authenticate API requests to GitHub 
- `GITHUB_RUN_ID`: A unique identifier for the specific workflow run. It can be used to fetch logs or track workflow execution


## How It Works

The action:
1. Uses the GitHub API to fetch workflow run information
2. Structures the data in a Splunk-friendly format
3. Sends the data to your Splunk instance via HTTP Event Collector
4. Optionally fetches and sends individual job log metadata
5. Implements retry logic for reliability

## Requirements

This action automatically installs:
- Python 3.12
- Required Python packages (`requests`, `PyGithub`)


## Splunk Event Message Format
### Workflow Event
```json
{
    "event": {
        "workflow": {
            "id": 13592533082,
            "name": "PR Validation - Auto Triggered",
            "status": "completed",
            "conclusion": "success",
            "created_at": "2025-02-28T16:41:49+00:00",
            "updated_at": "2025-02-28T16:43:21+00:00",
            "url": "https://api.github.com/repos/Red-Hat-SFDC/redhatcrm/actions/runs/13592533082",
            "html_url": "https://github.com/Red-Hat-SFDC/redhatcrm/actions/runs/13592533082"
        },
        "repository": {
            "owner": "Red-Hat-SFDC",
            "name": "redhatcrm",
            "full_name": "Red-Hat-SFDC/redhatcrm"
        }
    },
    "sourcetype": "github:workflow:logs",
    "source": "github:Red-Hat-SFDC/redhatcrm:workflow:PR Validation - Auto Triggered"
}
```

### Job Event
```json
{
    "event": {
        "job_id": 38001869842,
        "job_name": "Validate Changed Packages",
        "job_status": "skipped",
        "job_created_at": "2025-02-28T16:41:51+00:00",
        "job_completed_at": "2025-02-28T16:41:51+00:00",
        "job.status": "completed",
        "workflow_name": "PR Validation - Auto Triggered",
        "workflow_run_id": 13592533082,
        "logs": ""
    },
    "sourcetype": "github:workflow:logs:job",
    "source": "github:Red-Hat-SFDC/redhatcrm:workflow:PR Validation - Auto Triggered:job:Validate Changed Packages"
}
```
```json
{
    "event": {
        "job_id": 38001870192,
        "job_name": "See if Static Analysis should run",
        "job_status": "success",
        "job_created_at": "2025-02-28T16:41:52+00:00",
        "job_completed_at": "2025-02-28T16:42:28+00:00",
        "job.status": "completed",
        "workflow_name": "PR Validation - Auto Triggered",
        "workflow_run_id": 13592533082,
        "logs": "Logs unavailable for job: See if Static Analysis should run"
    },
    "sourcetype": "github:workflow:logs:job",
    "source": "github:Red-Hat-SFDC/redhatcrm:workflow:PR Validation - Auto Triggered:job:See if Static Analysis should run"
}
```